<!-- Weekly Reports -->
<div class="flex flex-col min-h-screen bg-background-light dark:bg-background-dark">
    <!-- Header -->
    <header class="app-header glass">
        <div class="flex items-center gap-3">
            <button class="app-header-btn" data-nav="admin-dashboard">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h1 class="app-header-title">Relatorios Semanais</h1>
        </div>
        <button class="app-header-btn" data-modal-open="settings-modal">
            <span class="material-symbols-outlined">settings</span>
        </button>
    </header>

    <!-- Date Navigator -->
    <div class="p-4 bg-card-light dark:bg-card-dark border-b border-border-light dark:border-border-dark">
        <div class="flex items-center justify-between bg-background-light dark:bg-background-dark rounded-lg p-1 border border-border-light dark:border-border-dark">
            <button class="w-10 h-10 flex items-center justify-center rounded-md hover:bg-card-light dark:hover:bg-card-dark text-muted transition-colors" id="prev-week">
                <span class="material-symbols-outlined">chevron_left</span>
            </button>
            <div class="flex flex-col items-center">
                <span class="text-sm font-semibold" id="week-range">Carregando...</span>
                <span class="text-xs text-muted" id="week-number">Semana --</span>
            </div>
            <button class="w-10 h-10 flex items-center justify-center rounded-md hover:bg-card-light dark:hover:bg-card-dark text-muted transition-colors" id="next-week">
                <span class="material-symbols-outlined">chevron_right</span>
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-1 p-4 pb-32 space-y-4 overflow-y-auto">
        <!-- Load Data Button -->
        <button class="btn btn-primary w-full" id="load-data-btn">
            <span class="material-symbols-outlined">sync</span>
            Carregar Dados da Semana
        </button>

        <!-- Summary Card -->
        <div class="card p-4">
            <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold">Resumo da Semana</h3>
                <span class="badge badge-primary" id="employees-badge">0 funcionarios</span>
            </div>
            <div class="grid grid-cols-3 gap-3 text-center">
                <div>
                    <p class="text-2xl font-bold text-primary" id="total-hours">0h</p>
                    <p class="text-xs text-muted">Horas Totais</p>
                </div>
                <div>
                    <p class="text-2xl font-bold text-success" id="total-payroll">R$ 0</p>
                    <p class="text-xs text-muted">Folha Total</p>
                </div>
                <div>
                    <p class="text-2xl font-bold" id="total-shifts">0</p>
                    <p class="text-xs text-muted">Turnos</p>
                </div>
            </div>
        </div>

        <!-- Global Settings (Collapsible) -->
        <details class="card group">
            <summary class="flex items-center justify-between p-4 cursor-pointer list-none">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                        <span class="material-symbols-outlined text-lg">tune</span>
                    </div>
                    <span class="font-semibold text-sm">Configuracoes Globais</span>
                </div>
                <span class="material-symbols-outlined text-muted transition-transform group-open:rotate-180">expand_more</span>
            </summary>
            <div class="px-4 pb-4 pt-1 border-t border-border-light dark:border-border-dark grid grid-cols-2 gap-4">
                <div class="space-y-1.5">
                    <label class="text-xs font-medium text-muted">Valor Hora</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-muted text-sm">R$</span>
                        <input type="number" step="0.01" class="input pl-9 text-sm" id="hourly-rate" value="15.00">
                    </div>
                </div>
                <div class="space-y-1.5">
                    <label class="text-xs font-medium text-muted">Vale Alimentacao/Dia</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-muted text-sm">R$</span>
                        <input type="number" step="0.01" class="input pl-9 text-sm" id="meal-allowance" value="25.00">
                    </div>
                </div>
            </div>
        </details>

        <!-- Employees Header -->
        <div class="flex items-center justify-between pt-2">
            <h2 class="text-sm font-bold text-muted uppercase tracking-wider" id="employees-header">Funcionarios (0)</h2>
            <div class="text-xs text-muted" id="total-to-pay">Total: R$ 0,00</div>
        </div>

        <!-- Employee Cards Container -->
        <div class="space-y-4" id="employees-container">
            <div class="p-8 text-center text-muted">
                <span class="material-symbols-outlined text-4xl mb-2">people</span>
                <p>Clique em "Carregar Dados" para ver os funcionarios</p>
            </div>
        </div>
    </main>

    <!-- Sticky Footer Actions -->
    <div class="fixed bottom-0 left-0 right-0 bg-card-light dark:bg-card-dark border-t border-border-light dark:border-border-dark p-4 pb-6 z-30 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
        <div class="flex gap-3 max-w-md mx-auto">
            <button class="btn btn-primary flex-1 h-12" id="save-report-btn">
                <span class="material-symbols-outlined">save</span>
                Salvar Relatorio
            </button>
            <button class="btn btn-secondary w-12 h-12 !p-0" title="Exportar PDF" id="export-pdf-btn">
                <span class="material-symbols-outlined">picture_as_pdf</span>
            </button>
            <button class="btn btn-secondary w-12 h-12 !p-0" title="Compartilhar" id="share-btn">
                <span class="material-symbols-outlined">share</span>
            </button>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div id="settings-modal-overlay" class="modal-overlay"></div>
<div id="settings-modal" class="fixed inset-x-0 bottom-0 z-50 bg-card-light dark:bg-card-dark rounded-t-2xl shadow-2xl transform translate-y-full transition-transform duration-300 max-h-[90vh] overflow-y-auto" style="display: none;">
    <div class="p-6">
        <div class="w-12 h-1.5 bg-border-light dark:bg-border-dark rounded-full mx-auto mb-6"></div>

        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold">Configuracoes do Relatorio</h2>
            <button class="p-2 rounded-full hover:bg-background-light dark:hover:bg-background-dark" data-modal-close="settings-modal">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>

        <div class="space-y-4">
            <div>
                <label class="text-sm font-medium text-muted block mb-2">Valor da Hora (R$)</label>
                <input type="number" step="0.01" class="input" id="settings-hourly-rate" value="15.00">
            </div>
            <div>
                <label class="text-sm font-medium text-muted block mb-2">Vale Alimentacao por Dia (R$)</label>
                <input type="number" step="0.01" class="input" id="settings-meal-allowance" value="25.00">
            </div>
            <div>
                <label class="text-sm font-medium text-muted block mb-2">Vale Transporte por Dia (R$)</label>
                <input type="number" step="0.01" class="input" id="settings-transport-allowance" value="10.00">
            </div>

            <button class="btn btn-primary w-full" id="save-settings-btn">
                <span class="material-symbols-outlined">save</span>
                Salvar Configuracoes
            </button>
        </div>
    </div>
</div>

<script type="module">
const ReportsController = {
    users: [],
    shifts: [],
    reportData: [],
    currentWeekStart: null,
    settings: {
        hourlyRate: 15.00,
        mealAllowance: 25.00,
        transportAllowance: 10.00
    },

    async init() {
        console.log('Initializing Reports...');

        this.setCurrentWeek();
        this.setupEventListeners();
        await this.loadSettings();
        await this.loadUsers();
    },

    setCurrentWeek() {
        const now = new Date();
        const dayOfWeek = now.getDay();
        const diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Adjust for Sunday
        this.currentWeekStart = new Date(now.setDate(diff));
        this.currentWeekStart.setHours(0, 0, 0, 0);
        this.updateWeekDisplay();
    },

    updateWeekDisplay() {
        const start = this.currentWeekStart;
        const end = new Date(start);
        end.setDate(end.getDate() + 6);

        const formatDate = (d) => d.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
        document.getElementById('week-range').textContent = `${formatDate(start)} - ${formatDate(end)}`;

        // Week number calculation
        const firstDayOfYear = new Date(start.getFullYear(), 0, 1);
        const pastDaysOfYear = (start - firstDayOfYear) / 86400000;
        const weekNumber = Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        document.getElementById('week-number').textContent = `Semana ${weekNumber}, ${start.getFullYear()}`;
    },

    setupEventListeners() {
        // Week navigation
        document.getElementById('prev-week')?.addEventListener('click', () => {
            this.currentWeekStart.setDate(this.currentWeekStart.getDate() - 7);
            this.updateWeekDisplay();
        });

        document.getElementById('next-week')?.addEventListener('click', () => {
            this.currentWeekStart.setDate(this.currentWeekStart.getDate() + 7);
            this.updateWeekDisplay();
        });

        // Load data button
        document.getElementById('load-data-btn')?.addEventListener('click', async () => {
            await this.loadWeekData();
        });

        // Settings sync
        document.getElementById('hourly-rate')?.addEventListener('change', (e) => {
            this.settings.hourlyRate = parseFloat(e.target.value) || 15;
            this.recalculatePayroll();
        });

        document.getElementById('meal-allowance')?.addEventListener('change', (e) => {
            this.settings.mealAllowance = parseFloat(e.target.value) || 25;
            this.recalculatePayroll();
        });

        // Modal handling
        document.querySelectorAll('[data-modal-open]').forEach(btn => {
            btn.addEventListener('click', () => this.openModal(btn.dataset.modalOpen));
        });

        document.querySelectorAll('[data-modal-close]').forEach(btn => {
            btn.addEventListener('click', () => this.closeModal(btn.dataset.modalClose));
        });

        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', () => {
                const modalId = overlay.id.replace('-overlay', '');
                this.closeModal(modalId);
            });
        });

        // Save settings
        document.getElementById('save-settings-btn')?.addEventListener('click', async () => {
            await this.saveSettings();
        });

        // Save report
        document.getElementById('save-report-btn')?.addEventListener('click', () => {
            App.showToast('Relatorio salvo com sucesso!', 'success');
        });

        // Export PDF
        document.getElementById('export-pdf-btn')?.addEventListener('click', () => {
            App.showToast('Funcao de exportar PDF em desenvolvimento', 'info');
        });

        // Share
        document.getElementById('share-btn')?.addEventListener('click', () => {
            if (navigator.share) {
                navigator.share({
                    title: 'Relatorio Semanal - Pastelaria 24h',
                    text: `Relatorio da semana ${document.getElementById('week-range').textContent}`
                });
            } else {
                App.showToast('Compartilhamento nao disponivel', 'warning');
            }
        });
    },

    openModal(modalId) {
        const modal = document.getElementById(modalId);
        const overlay = document.getElementById(modalId + '-overlay');

        if (modal && overlay) {
            // Sync settings values
            document.getElementById('settings-hourly-rate').value = this.settings.hourlyRate;
            document.getElementById('settings-meal-allowance').value = this.settings.mealAllowance;
            document.getElementById('settings-transport-allowance').value = this.settings.transportAllowance;

            modal.style.display = 'block';
            overlay.classList.add('active');
            setTimeout(() => {
                modal.style.transform = 'translateY(0)';
            }, 10);
        }
    },

    closeModal(modalId) {
        const modal = document.getElementById(modalId);
        const overlay = document.getElementById(modalId + '-overlay');

        if (modal && overlay) {
            modal.style.transform = 'translateY(100%)';
            overlay.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }
    },

    async loadSettings() {
        try {
            const { getSettings } = await import('/js/firebase-config.js');
            const settings = await getSettings();
            if (settings) {
                this.settings = { ...this.settings, ...settings };
                document.getElementById('hourly-rate').value = this.settings.hourlyRate;
                document.getElementById('meal-allowance').value = this.settings.mealAllowance;
            }
        } catch (error) {
            console.log('Using default settings');
        }
    },

    async saveSettings() {
        this.settings.hourlyRate = parseFloat(document.getElementById('settings-hourly-rate').value) || 15;
        this.settings.mealAllowance = parseFloat(document.getElementById('settings-meal-allowance').value) || 25;
        this.settings.transportAllowance = parseFloat(document.getElementById('settings-transport-allowance').value) || 10;

        try {
            const { updateSettings } = await import('/js/firebase-config.js');
            await updateSettings(this.settings);
            App.showToast('Configuracoes salvas!', 'success');
            this.closeModal('settings-modal');
            this.recalculatePayroll();
        } catch (error) {
            console.error('Error saving settings:', error);
            App.showToast('Erro ao salvar configuracoes', 'danger');
        }
    },

    async loadUsers() {
        try {
            const { subscribeToUsers } = await import('/js/firebase-config.js');

            const unsub = subscribeToUsers((users) => {
                this.users = users.filter(u => u.role === 'staff' || u.role === 'admin');
            });

            if (window.App?.state?.unsubscribers) {
                window.App.state.unsubscribers.push(unsub);
            }
        } catch (error) {
            console.error('Error loading users:', error);
        }
    },

    async loadWeekData() {
        const btn = document.getElementById('load-data-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Carregando...';

        try {
            const { getShiftHistory } = await import('/js/firebase-config.js');

            const weekEnd = new Date(this.currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 7);

            const shifts = await getShiftHistory(this.currentWeekStart.getTime(), weekEnd.getTime());
            this.shifts = shifts;

            this.calculateReportData();
            this.renderEmployees();

            App.showToast('Dados carregados!', 'success');
        } catch (error) {
            console.error('Error loading week data:', error);
            App.showToast('Erro ao carregar dados', 'danger');

            // Show demo data for testing
            this.generateDemoData();
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<span class="material-symbols-outlined">sync</span> Carregar Dados da Semana';
        }
    },

    generateDemoData() {
        // Generate demo data based on users
        this.reportData = this.users.map(user => ({
            userId: user.id,
            userName: user.name,
            role: user.role === 'admin' ? 'Administrador' : 'Funcionario',
            transport: user.transport,
            hoursWorked: Math.floor(Math.random() * 20) + 30,
            daysWorked: Math.floor(Math.random() * 3) + 4,
            shiftsCount: Math.floor(Math.random() * 3) + 4,
            storeConsumption: Math.floor(Math.random() * 50),
            bonus: 0,
            discount: 0
        }));

        this.updateSummary();
        this.renderEmployees();
    },

    calculateReportData() {
        const userShifts = {};

        this.shifts.forEach(shift => {
            if (!userShifts[shift.userId]) {
                userShifts[shift.userId] = {
                    shifts: [],
                    totalHours: 0,
                    daysWorked: new Set()
                };
            }

            const duration = (shift.endTime || Date.now()) - shift.startTime;
            const hours = duration / 3600000;

            userShifts[shift.userId].shifts.push(shift);
            userShifts[shift.userId].totalHours += hours;
            userShifts[shift.userId].daysWorked.add(new Date(shift.startTime).toDateString());
        });

        this.reportData = this.users.map(user => {
            const userData = userShifts[user.id] || { shifts: [], totalHours: 0, daysWorked: new Set() };

            return {
                userId: user.id,
                userName: user.name,
                role: user.role === 'admin' ? 'Administrador' : 'Funcionario',
                transport: user.transport,
                hoursWorked: Math.round(userData.totalHours),
                daysWorked: userData.daysWorked.size,
                shiftsCount: userData.shifts.length,
                storeConsumption: 0,
                bonus: 0,
                discount: 0
            };
        }).filter(r => r.hoursWorked > 0 || r.shiftsCount > 0);

        this.updateSummary();
    },

    recalculatePayroll() {
        this.updateSummary();
        this.renderEmployees();
    },

    calculateEmployeePayroll(employee) {
        const hoursPayment = employee.hoursWorked * this.settings.hourlyRate;
        const mealPayment = employee.daysWorked * this.settings.mealAllowance;
        const transportPayment = employee.transport ? employee.daysWorked * this.settings.transportAllowance : 0;

        const total = hoursPayment + mealPayment + transportPayment + (employee.bonus || 0) - (employee.discount || 0) - (employee.storeConsumption || 0);

        return {
            hoursPayment,
            mealPayment,
            transportPayment,
            total
        };
    },

    updateSummary() {
        let totalHours = 0;
        let totalPayroll = 0;
        let totalShifts = 0;

        this.reportData.forEach(emp => {
            totalHours += emp.hoursWorked;
            totalShifts += emp.shiftsCount;
            totalPayroll += this.calculateEmployeePayroll(emp).total;
        });

        document.getElementById('total-hours').textContent = `${totalHours}h`;
        document.getElementById('total-payroll').textContent = this.formatCurrency(totalPayroll);
        document.getElementById('total-shifts').textContent = totalShifts;
        document.getElementById('employees-badge').textContent = `${this.reportData.length} funcionarios`;
        document.getElementById('employees-header').textContent = `Funcionarios (${this.reportData.length})`;
        document.getElementById('total-to-pay').textContent = `Total: ${this.formatCurrency(totalPayroll)}`;
    },

    renderEmployees() {
        const container = document.getElementById('employees-container');
        if (!container) return;

        if (this.reportData.length === 0) {
            container.innerHTML = `
                <div class="p-8 text-center text-muted">
                    <span class="material-symbols-outlined text-4xl mb-2">people</span>
                    <p>Nenhum dado encontrado para esta semana</p>
                </div>
            `;
            return;
        }

        container.innerHTML = this.reportData.map((emp, index) => {
            const payroll = this.calculateEmployeePayroll(emp);
            const transportIcons = {
                car: 'directions_car',
                motorcycle: 'two_wheeler',
                bus: 'directions_bus',
                walk: 'directions_walk'
            };

            return `
                <div class="card overflow-hidden">
                    <div class="p-4 border-b border-border-light dark:border-border-dark flex justify-between items-center bg-background-light/50 dark:bg-background-dark/50">
                        <div class="flex items-center gap-3">
                            <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(emp.userName)}&background=random" alt="${emp.userName}" class="w-10 h-10 rounded-full">
                            <div>
                                <h3 class="font-bold leading-tight">${emp.userName}</h3>
                                <p class="text-xs text-muted">${emp.role}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-muted">A Pagar</div>
                            <div class="text-lg font-bold text-success">${this.formatCurrency(payroll.total)}</div>
                        </div>
                    </div>
                    <div class="p-4">
                        <div class="grid grid-cols-2 gap-y-3 gap-x-4 mb-4">
                            <div class="flex flex-col">
                                <span class="text-xs uppercase tracking-wider text-muted font-medium">Horas Trabalhadas</span>
                                <span class="text-sm font-semibold">${emp.hoursWorked}h</span>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-xs uppercase tracking-wider text-muted font-medium">Transporte</span>
                                <span class="text-sm font-semibold">${this.formatCurrency(payroll.transportPayment)}</span>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-xs uppercase tracking-wider text-muted font-medium">Alimentacao</span>
                                <span class="text-sm font-semibold">${this.formatCurrency(payroll.mealPayment)}</span>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-xs uppercase tracking-wider text-muted font-medium">Consumo Loja</span>
                                <span class="text-sm font-semibold">${this.formatCurrency(emp.storeConsumption)}</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 pt-3 border-t border-dashed border-border-light dark:border-border-dark">
                            <div class="space-y-1">
                                <label class="text-xs font-medium text-success flex items-center gap-1">
                                    <span class="material-symbols-outlined text-sm">add_circle</span>
                                    Adicional
                                </label>
                                <div class="relative">
                                    <span class="absolute left-2.5 top-1/2 -translate-y-1/2 text-muted text-xs">R$</span>
                                    <input type="number" step="0.01" class="input pl-7 text-sm h-9" placeholder="0,00"
                                           data-employee="${index}" data-field="bonus"
                                           value="${emp.bonus || ''}"
                                           onchange="ReportsController.updateEmployeeField(${index}, 'bonus', this.value)">
                                </div>
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-medium text-danger flex items-center gap-1">
                                    <span class="material-symbols-outlined text-sm">remove_circle</span>
                                    Desconto
                                </label>
                                <div class="relative">
                                    <span class="absolute left-2.5 top-1/2 -translate-y-1/2 text-muted text-xs">R$</span>
                                    <input type="number" step="0.01" class="input pl-7 text-sm h-9" placeholder="0,00"
                                           data-employee="${index}" data-field="discount"
                                           value="${emp.discount || ''}"
                                           onchange="ReportsController.updateEmployeeField(${index}, 'discount', this.value)">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    },

    updateEmployeeField(index, field, value) {
        if (this.reportData[index]) {
            this.reportData[index][field] = parseFloat(value) || 0;
            this.updateSummary();
            // Update the total display for this employee
            const payroll = this.calculateEmployeePayroll(this.reportData[index]);
            const cards = document.querySelectorAll('.card');
            // Simple approach: re-render for now
            this.renderEmployees();
        }
    },

    formatCurrency(value) {
        return new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(value || 0);
    }
};

// Initialize
window.ReportsController = ReportsController;
ReportsController.init();
</script>
